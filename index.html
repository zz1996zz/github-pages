<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ì•¼ë°”ìœ„ ê²Œì„ â€“ HTML/CSS/JS</title>
  <style>
    :root{
      --bg:#0f1221;
      --panel:#141833;
      --text:#e8ebff;
      --muted:#aab0d3;
      --accent:#6aa6ff;
      --win:#34d399;
      --lose:#f87171;
      --cup:#2b3166;
      --cup-edge:#1d224a;
      --cup-highlight: #6aa6ff33;
      --ball:#ffcc00;

      --stage-max: 960px;
      --cup-size: clamp(78px, 12vw, 140px);
      --cup-radius: 18px;
      --cup-lift: 18%;
      --gap: clamp(12px, 4vw, 32px);
      --panel-pad: clamp(12px, 2.6vw, 22px);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, "Apple SD Gothic Neo", "ë§‘ì€ ê³ ë”•", sans-serif;
      color:var(--text);
      background: radial-gradient(1200px 800px at 60% -10%, #1a1f45 0%, #0f1221 60%, #0b0d18 100%);
      -webkit-tap-highlight-color: transparent;
    }

    .wrap{
      min-height:100%;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:16px;
      padding: 16px env(safe-area-inset-right) 32px env(safe-area-inset-left);
    }

    header{
      width:100%;
      max-width:var(--stage-max);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
    }
    .title{
      font-weight:800;
      letter-spacing:0.2px;
      font-size: clamp(18px, 3.6vw, 28px);
      display:flex; align-items:center; gap:10px;
    }
    .title .dot{ width:10px;height:10px;border-radius:50%; background:var(--accent); box-shadow:0 0 16px var(--accent)}

    .panel{
      width:100%;
      max-width:var(--stage-max);
      background:linear-gradient(180deg, #171b3c 0%, #101433 100%);
      border:1px solid #252a5a;
      box-shadow: 0 10px 30px rgba(0,0,0,.35), inset 0 1px 0 #26306b;
      border-radius: 16px;
      padding: var(--panel-pad);
    }

    .controls{ display:flex; flex-wrap:wrap; gap:12px; align-items:center; justify-content:space-between }
    .controls .left, .controls .right{ display:flex; align-items:center; gap:10px; flex-wrap:wrap }
    .label{ color:var(--muted); font-size: 14px }

    select, button, input[type="range"]{
      appearance:none; -webkit-appearance:none;
      background:#0f1433; color:var(--text);
      border:1px solid #2d346b; border-radius:12px;
      padding:10px 12px; font-weight:600;
    }
    select:focus, button:focus, input[type="range"]:focus{ outline:2px solid #3656b8; outline-offset:2px }

    button.primary{
      background: linear-gradient(180deg, #3b82f6, #2563eb);
      border: none; color:white; padding: 12px 14px; border-radius: 12px;
      box-shadow: 0 6px 16px rgba(59,130,246,.35);
      font-weight:800; letter-spacing:.2px;
      cursor:pointer;
    }
    button.primary[disabled]{ opacity:.55; cursor:not-allowed }

    .score{ display:flex; gap:12px; align-items:center; }
    .score .pill{
      background:#0d1230; border:1px solid #2a3270; border-radius:999px; padding:8px 12px; font-weight:700; font-size:14px
    }
    .pill.win{ color:var(--win); border-color:#1d8b6a }
    .pill.lose{ color:var(--lose); border-color:#943a3a }

    .stage-panel{ display:grid; gap:14px }
    .hint{ color:var(--muted); font-size:13px }

    .stage{
      position:relative;
      width:100%;
      aspect-ratio: 16/9;
      max-height: 66vh;
      min-height: 300px;
      border-radius: 18px;
      background: radial-gradient(900px 500px at 50% 100%, #0e1334 0%, #0a0d23 50%, #080a1a 100%);
      border:1px solid #23295a;
      box-shadow: inset 0 6px 24px rgba(0,0,0,.4), 0 20px 40px rgba(0,0,0,.45);
      overflow:hidden;
      user-select:none;
      touch-action: manipulation;
    }

    .table-line{ position:absolute; inset:auto 0 16%; height:2px; background: linear-gradient(90deg,#263072,transparent,#263072); opacity:.6 }

    .cup{
      position:absolute;
      width: var(--cup-size); height: calc(var(--cup-size) * 1.1);
      border-radius: var(--cup-radius) var(--cup-radius) 6px 6px;
      background: radial-gradient(120% 100% at 30% 20%, #3a4286 0%, var(--cup) 45%, var(--cup-edge) 100%);
      border: 1px solid #1a1f48;
      box-shadow: inset 0 2px 10px #00000055, 0 10px 24px rgba(0,0,0,.6);
      transform: translate(-50%, -50%) translate3d(0,0,0);
      top: 64%;
      left: 50%;
      display:grid; place-items:end center;
      transition: transform var(--speed, .36s) cubic-bezier(.2,.7,.2,1);
      will-change: transform;
      cursor:pointer;
    }
    .cup::before{
      content:""; position:absolute; inset:8px 8px auto 8px; height:32%; border-radius: 12px; background: linear-gradient(180deg, var(--cup-highlight), transparent);
    }
    .cup::after{
      content:""; position:absolute; inset:auto 22% -8px 22%; height:12px; border-radius: 999px; background: radial-gradient(100% 100% at 50% 20%, #00000077 10%, transparent 70%);
      filter: blur(2px);
    }

    .cup[aria-disabled="true"]{ pointer-events:none }

    .cup.lift{ transform: translate(var(--tx,0), var(--ty,0)) translateY(calc(-1 * var(--cup-lift))); }

    .ball{ position:absolute; width: clamp(16px, 2.5vw, 26px); height: clamp(16px, 2.5vw, 26px); border-radius:50%; background: radial-gradient(100% 100% at 30% 30%, #fff4b2, var(--ball));
      top: calc(64% + 4px); left: 50%; transform: translate(-50%, -50%);
      box-shadow: 0 4px 12px #00000077;
      transition: left .25s ease-out, opacity .2s ease-out;
      will-change:left,opacity;
      opacity:0; pointer-events:none;
    }

    .toast{
      position:absolute; inset: 10px 10px auto auto; z-index: 3;
      background:#0c1130cc; border:1px solid #2a3270; color:var(--text);
      padding:8px 12px; border-radius:10px; font-size:14px; backdrop-filter: blur(6px);
      transform: translateY(-4px); opacity:0; transition: .25s ease;
    }
    .toast.show{ transform: none; opacity:1 }

    .footer-hint{ color:var(--muted); font-size:12px; text-align:center; margin-top:10px }
    .kbd{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; background:#0a0e27; border:1px solid #2a3270; padding:2px 6px; border-radius:6px }

  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title"><span class="dot"></span> ì•¼ë°”ìœ„ ê²Œì„</div>
      <div class="score">
        <div class="pill">ë¼ìš´ë“œ <span id="round">0</span></div>
        <div class="pill win">ì •ë‹µ <span id="wins">0</span></div>
        <div class="pill lose">ì‹¤íŒ¨ <span id="losses">0</span></div>
      </div>
    </header>

    <section class="panel">
      <div class="controls">
        <div class="left">
          <label class="label" for="difficulty">ë‚œì´ë„</label>
          <select id="difficulty" aria-label="ë‚œì´ë„">
            <option value="easy">ì‰¬ì›€</option>
            <option value="normal" selected>ë³´í†µ</option>
            <option value="hard">ì–´ë ¤ì›€</option>
            <option value="insane">ë§¤ìš° ì–´ë ¤ì›€</option>
          </select>
          <span class="label">ì„ê¸° íšŸìˆ˜</span>
          <input type="range" id="swaps" min="6" max="24" step="1" value="10"/>
          <span id="swapsVal" class="label">10íšŒ</span>
        </div>
        <div class="right">
          <button id="startBtn" class="primary">ë¼ìš´ë“œ ì‹œì‘</button>
        </div>
      </div>
    </section>

    <section class="panel stage-panel">
      <div class="hint">ê³µ ìœ„ì¹˜ë¥¼ 1ì´ˆê°„ ë³´ì—¬ì¤€ ë’¤ ì»µì„ ì„ìŠµë‹ˆë‹¤. ì„ê¸°ê°€ ëë‚˜ë©´ ì»µì„ ëˆŒëŸ¬ ë§ì¶°ë³´ì„¸ìš”!</div>
      <div class="stage" id="stage" role="application" aria-label="ì•¼ë°”ìœ„ ê²Œì„ ë¬´ëŒ€">
        <div class="toast" id="toast" aria-live="polite" aria-atomic="true"></div>
        <div class="table-line"></div>
        <button class="cup" id="cup0" aria-label="ì™¼ìª½ ì»µ" aria-disabled="true"></button>
        <button class="cup" id="cup1" aria-label="ê°€ìš´ë° ì»µ" aria-disabled="true"></button>
        <button class="cup" id="cup2" aria-label="ì˜¤ë¥¸ìª½ ì»µ" aria-disabled="true"></button>
        <div class="ball" id="ball" aria-hidden="true"></div>
      </div>
      <div class="footer-hint">í‚¤ë³´ë“œ <span class="kbd">1</span>/<span class="kbd">2</span>/<span class="kbd">3</span> ì„ íƒ, <span class="kbd">Enter</span> ì‹œì‘</div>
    </section>
  </div>

  <script>
  (function(){
    const stage = document.getElementById('stage');
    const cups = [0,1,2].map(i => document.getElementById('cup'+i));
    const ball = document.getElementById('ball');
    const startBtn = document.getElementById('startBtn');
    const difficultySel = document.getElementById('difficulty');
    const swapsInput = document.getElementById('swaps');
    const swapsVal = document.getElementById('swapsVal');
    const roundEl = document.getElementById('round');
    const winsEl = document.getElementById('wins');
    const lossesEl = document.getElementById('losses');
    const toast = document.getElementById('toast');

    let xPositions = [0,0,0];
    let mapping = [0,1,2]; // posIndex -> cupIndex currently occupying that position
    let posOfCup = [0,1,2]; // inverse mapping: cupIndex -> posIndex
    let speed = 360; // ms
    let shuffling = false;
    let round = 0, wins = 0, losses = 0;
    let ballCup = 1; // cup index that holds the ball (initial center)

    // persistent best score (optional)
    let best = JSON.parse(localStorage.getItem('shell-best')||'{}');

    function setToast(msg){
      toast.textContent = msg;
      toast.classList.add('show');
      clearTimeout(setToast._t);
      setToast._t = setTimeout(()=> toast.classList.remove('show'), 1800);
    }

    function updateSwapsVal(){ swapsVal.textContent = swapsInput.value + 'íšŒ'; }

    function computePositions(){
      const rect = stage.getBoundingClientRect();
      const cupW = cups[0].getBoundingClientRect().width || parseFloat(getComputedStyle(cups[0]).width);
      const centerY = rect.height * 0.64; // keep in sync with .cup top:64%
      const centerX = rect.width/2;
      const spacing = Math.min(rect.width * 0.26, 220);
      xPositions = [centerX - spacing, centerX, centerX + spacing];
      cups.forEach((cup, i)=>{
        const pos = posOfCup[i];
        const tx = (xPositions[pos] - centerX);
        cup.style.setProperty('--tx', tx.toFixed(2) + 'px');
        cup.style.setProperty('--ty', (centerY - rect.height*0.64).toFixed(2) + 'px');
        cup.style.transform = `translate(${tx}px, 0)`; // baseline (overrides initial translate(-50%,-50%) via css? We'll keep origin center by initial and add translate)
      });
      updateBallPosition();
    }

    function setCupsInteractive(enabled){ cups.forEach(c => c.setAttribute('aria-disabled', enabled? 'false' : 'true')); }

    function difficultyToParams(val){
      switch(val){
        case 'easy': return {speed: 420, delay: 80};
        case 'normal': return {speed: 340, delay: 60};
        case 'hard': return {speed: 260, delay: 45};
        case 'insane': return {speed: 190, delay: 36};
        default: return {speed: 340, delay: 60};
      }
    }

    // Promise transition end helper
    function onceTransition(el){
      return new Promise(res=>{
        const onEnd = (e)=>{
          if (e.target !== el) return;
          el.removeEventListener('transitionend', onEnd);
          res();
        };
        el.addEventListener('transitionend', onEnd, {once:false});
      });
    }

    function sleep(ms){ return new Promise(r=> setTimeout(r, ms)); }

    function updateBallPosition(visible=false){
      const rect = stage.getBoundingClientRect();
      const centerX = rect.width/2;
      const x = xPositions[posOfCup[ballCup]]; // center x of the cup holding the ball
      ball.style.left = ((x / rect.width) * 100) + '%';
      ball.style.opacity = visible ? 1 : 0;
    }

    async function flashBall(){
      updateBallPosition(true);
      await sleep(900);
      ball.style.opacity = 0;
    }

    async function swapPositions(i, j){
      // i, j are position indices to swap occupants
      const cupI = mapping[i];
      const cupJ = mapping[j];
      // update inverse mapping posOfCup
      posOfCup[cupI] = j;
      posOfCup[cupJ] = i;
      // update forward mapping
      mapping[i] = cupJ;
      mapping[j] = cupI;

      // animate cups to new x via CSS variable --tx
      const centerX = stage.getBoundingClientRect().width/2;
      const txI = (xPositions[j] - centerX);
      const txJ = (xPositions[i] - centerX);
      cups[cupI].style.setProperty('--tx', txI.toFixed(2) + 'px');
      cups[cupJ].style.setProperty('--tx', txJ.toFixed(2) + 'px');
      cups[cupI].style.transform = `translate(${txI}px, 0)`;
      cups[cupJ].style.transform = `translate(${txJ}px, 0)`;
      await Promise.all([onceTransition(cups[cupI]), onceTransition(cups[cupJ])]);
    }

    async function shuffle(times){
      shuffling = true;
      setCupsInteractive(false);
      cups.forEach(c=> c.style.setProperty('--speed', (speed/1000)+'s'));
      for (let k=0; k<times; k++){
        // pick two distinct positions to swap (0,1,2)
        let a = Math.floor(Math.random()*3);
        let b = (a + 1 + Math.floor(Math.random()*2)) % 3; // ensure different, biased to neighbor for nicer animation
        await swapPositions(a,b);
        // small dead time for visual clarity
        await sleep(Math.max(0, Math.floor(speed*0.12)));
      }
      shuffling = false;
      setCupsInteractive(true);
    }

    async function startRound(){
      if (shuffling) return;
      round++;
      roundEl.textContent = String(round);
      startBtn.disabled = true;
      setCupsInteractive(false);
      setToast('ê³µ ìœ„ì¹˜ ë¯¸ë¦¬ë³´ê¸°! (1ì´ˆ)');

      // choose random cup for ball
      ballCup = Math.floor(Math.random()*3);
      updateBallPosition(true);
      await sleep(1000);
      ball.style.opacity = 0;

      // set speed by difficulty
      const {speed:sp, delay} = difficultyToParams(difficultySel.value);
      speed = sp;
      cups.forEach(c=> c.style.setProperty('--speed', (speed/1000)+'s'));

      // shuffle mapping many times
      await shuffle(parseInt(swapsInput.value,10));
      setToast('ì´ì œ ë§ì¶°ë³´ì„¸ìš”!');
    }

    function endRound(correct){
      if (correct){ wins++; winsEl.textContent = String(wins); setToast('ì •ë‹µ! ğŸ‰'); } else { losses++; lossesEl.textContent = String(losses); setToast('ì•„ì‰½ë„¤ìš”! ğŸ˜­'); }
      // update best
      const total = wins + losses;
      const acc = total? Math.round((wins/total)*100) : 0;
      best = {wins, losses, acc};
      localStorage.setItem('shell-best', JSON.stringify(best));
      startBtn.disabled = false;
    }

    async function onPick(cupIndex){
      if (shuffling) return;
      if (cups[cupIndex].getAttribute('aria-disabled') === 'true') return;
      setCupsInteractive(false);

      // lift clicked cup
      cups[cupIndex].classList.add('lift');
      // vibrate feedback
      try{ if (navigator.vibrate) navigator.vibrate([cupIndex===ballCup? 35:120]); }catch{}

      // move ball under its cup and reveal
      updateBallPosition(true);
      await sleep(650);

      // put down cup
      cups[cupIndex].classList.remove('lift');
      await sleep(200);
      ball.style.opacity = 0;

      endRound(cupIndex===ballCup);
    }

    function initPositions(){
      // initial layout: cups in 0,1,2 positions, ball at cup1
      mapping = [0,1,2];
      posOfCup = [0,1,2];
      computePositions();
    }

    // Event bindings
    window.addEventListener('resize', computePositions);
    startBtn.addEventListener('click', startRound);
    cups.forEach((cup, idx)=> cup.addEventListener('click', ()=> onPick(idx)));
    swapsInput.addEventListener('input', updateSwapsVal);
    updateSwapsVal();

    // keyboard support
    window.addEventListener('keydown', (e)=>{
      if (e.key === 'Enter'){ startRound(); }
      else if (['1','2','3'].includes(e.key)){
        onPick(parseInt(e.key,10)-1);
      }
    });

    // initial
    initPositions();
    setToast('ë‚œì´ë„ì™€ ì„ê¸° íšŸìˆ˜ë¥¼ ê³ ë¥´ê³  ì‹œì‘í•´ë³´ì„¸ìš”!');
  })();
  </script>
</body>
</html>
